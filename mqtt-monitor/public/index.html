<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MQTT í†µì‹  ëª¨ë‹ˆí„°</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: #2d2d2d;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      color: #4CAF50;
    }

    .status {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #4CAF50;
      animation: pulse 2s infinite;
    }

    .status-indicator.disconnected {
      background: #f44336;
      animation: none;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: #2d2d2d;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
    }

    .stat-label {
      font-size: 12px;
      color: #aaa;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #4CAF50;
    }

    .controls {
      background: #2d2d2d;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .controls h3 {
      margin-bottom: 15px;
      color: #4CAF50;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #aaa;
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px;
      background: #1a1a1a;
      border: 1px solid #444;
      border-radius: 4px;
      color: #e0e0e0;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr auto;
      gap: 10px;
      align-items: end;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #4CAF50;
      color: white;
    }

    .btn-primary:hover {
      background: #45a049;
    }

    .btn-secondary {
      background: #2196F3;
      color: white;
    }

    .btn-secondary:hover {
      background: #0b7dda;
    }

    .btn-danger {
      background: #f44336;
      color: white;
    }

    .btn-danger:hover {
      background: #da190b;
    }

    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .filter-input {
      flex: 1;
      min-width: 200px;
    }

    .messages-container {
      background: #2d2d2d;
      border-radius: 8px;
      overflow: hidden;
    }

    .messages-header {
      padding: 15px 20px;
      background: #1a1a1a;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #444;
    }

    .messages-list {
      max-height: 600px;
      overflow-y: auto;
      padding: 10px;
    }

    .message-item {
      background: #1a1a1a;
      border-left: 4px solid #4CAF50;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .message-item.incoming {
      border-left-color: #2196F3;
    }

    .message-item.outgoing {
      border-left-color: #FF9800;
    }

    .message-item.system {
      border-left-color: #9E9E9E;
    }

    .message-item.error {
      border-left-color: #f44336;
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 11px;
    }

    .message-topic {
      color: #4CAF50;
      font-weight: bold;
    }

    .message-time {
      color: #aaa;
    }

    .message-direction {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: bold;
      margin-right: 8px;
    }

    .message-direction.incoming {
      background: #2196F3;
      color: white;
    }

    .message-direction.outgoing {
      background: #FF9800;
      color: white;
    }

    .message-direction.system {
      background: #9E9E9E;
      color: white;
    }

    .message-payload {
      color: #e0e0e0;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 200px;
      overflow-y: auto;
    }

    .topic-list {
      background: #2d2d2d;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .topic-list h3 {
      margin-bottom: 10px;
      color: #4CAF50;
    }

    .topic-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .topic-tag {
      background: #1a1a1a;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      color: #4CAF50;
      border: 1px solid #4CAF50;
      cursor: pointer;
      transition: all 0.3s;
    }

    .topic-tag:hover {
      background: #4CAF50;
      color: #1a1a1a;
    }

    .topic-tag.active {
      background: #4CAF50;
      color: #1a1a1a;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #aaa;
    }

    .test-scenarios {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .test-scenario {
      background: #1a1a1a;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #2196F3;
    }

    .test-scenario h4 {
      margin: 0 0 8px 0;
      color: #2196F3;
    }

    .test-scenario p {
      margin: 0 0 10px 0;
      color: #aaa;
      font-size: 12px;
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #1a1a1a;
    }

    ::-webkit-scrollbar-thumb {
      background: #444;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ” MQTT í†µì‹  ëª¨ë‹ˆí„°</h1>
      <div class="status">
        <div class="status-indicator" id="statusIndicator"></div>
        <span id="statusText">ì—°ê²°ë¨</span>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">ì´ ë©”ì‹œì§€ ìˆ˜</div>
        <div class="stat-value" id="totalMessages">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ìˆ˜ì‹  ë©”ì‹œì§€</div>
        <div class="stat-value" id="incomingMessages">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ë°œì‹  ë©”ì‹œì§€</div>
        <div class="stat-value" id="outgoingMessages">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ì—°ê²°ëœ í´ë¼ì´ì–¸íŠ¸</div>
        <div class="stat-value" id="connectedClients">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ê³ ìœ  í† í”½ ìˆ˜</div>
        <div class="stat-value" id="uniqueTopics">0</div>
      </div>
    </div>

    <div class="topic-list">
      <h3>í™œì„± í† í”½</h3>
      <div class="topic-tags" id="topicTags"></div>
    </div>

    <div class="controls">
      <h3>ë©”ì‹œì§€ ë°œí–‰ (í…ŒìŠ¤íŠ¸ìš©)</h3>
      <div class="form-row">
        <div class="form-group">
          <label>ë°œí–‰ ìœ„ì¹˜</label>
          <select id="publishSource" onchange="updatePublishUI()">
            <option value="monitor">MQTT Monitorì—ì„œ ì§ì ‘</option>
            <option value="backend">ë°±ì—”ë“œ APIë¥¼ í†µí•´</option>
          </select>
        </div>
        <div class="form-group">
          <label>í† í”½</label>
          <input type="text" id="publishTopic" placeholder="hub/AA:BB:CC:DD:EE:01/status" />
        </div>
        <div class="form-group">
          <label>QoS</label>
          <select id="publishQos">
            <option value="0">0</option>
            <option value="1" selected>1</option>
            <option value="2">2</option>
          </select>
        </div>
        <div class="form-group">
          <label>Retain</label>
          <select id="publishRetain">
            <option value="false" selected>False</option>
            <option value="true">True</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="publishMessage()">ë°œí–‰</button>
      </div>
      <div class="form-group">
        <label>ë©”ì‹œì§€ (JSON ë˜ëŠ” í…ìŠ¤íŠ¸)</label>
        <textarea id="publishMessage" placeholder='{"status": "online"}'></textarea>
      </div>
      <div id="backendConfig" style="display: none; margin-top: 10px; padding: 10px; background: #1a1a1a; border-radius: 4px;">
        <div class="form-group">
          <label>ë°±ì—”ë“œ URL</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="text" id="backendUrl" value="http://localhost:5000" placeholder="http://localhost:5000" style="flex: 1;" />
            <button class="btn btn-secondary" onclick="testBackendConnection()" style="white-space: nowrap;">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
          </div>
          <div id="backendStatus" style="margin-top: 5px; font-size: 12px; color: #aaa;"></div>
        </div>
      </div>
      <!-- ë°±ì—”ë“œ URLì„ í•­ìƒ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ìˆ¨ê²¨ì§„ í•„ë“œë¡œë„ ì €ì¥ -->
      <input type="hidden" id="backendUrlHidden" value="http://localhost:5000" />
      <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button class="btn btn-secondary" onclick="clearLog()">ë¡œê·¸ ì´ˆê¸°í™”</button>
        <button class="btn btn-secondary" onclick="loadRecentMessages()">ìµœê·¼ ë©”ì‹œì§€ ìƒˆë¡œê³ ì¹¨</button>
        <button class="btn btn-secondary" onclick="runBidirectionalTest()">ì–‘ë°©í–¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
      </div>
    </div>

    <div class="controls" id="testScenarios" style="display: none;">
      <h3>ì–‘ë°©í–¥ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤</h3>
      <div class="test-scenarios">
        <div class="test-scenario">
          <h4>ì‹œë‚˜ë¦¬ì˜¤ 1: Monitor â†’ Backend</h4>
          <p>MQTT Monitorì—ì„œ ë©”ì‹œì§€ë¥¼ ë°œí–‰í•˜ê³  ë°±ì—”ë“œê°€ ìˆ˜ì‹ í•˜ëŠ”ì§€ í™•ì¸</p>
          <button class="btn btn-primary" onclick="testScenario1()">ì‹¤í–‰</button>
        </div>
        <div class="test-scenario">
          <h4>ì‹œë‚˜ë¦¬ì˜¤ 2: Backend â†’ Monitor</h4>
          <p>ë°±ì—”ë“œ APIë¥¼ í†µí•´ ë©”ì‹œì§€ë¥¼ ë°œí–‰í•˜ê³  Monitorê°€ ìˆ˜ì‹ í•˜ëŠ”ì§€ í™•ì¸</p>
          <button class="btn btn-primary" onclick="testScenario2()">ì‹¤í–‰</button>
        </div>
        <div class="test-scenario">
          <h4>ì‹œë‚˜ë¦¬ì˜¤ 3: í—ˆë¸Œ ìƒíƒœ ì‹œë®¬ë ˆì´ì…˜</h4>
          <p>í—ˆë¸Œê°€ ë°±ì—”ë“œì— ìƒíƒœë¥¼ ì „ì†¡í•˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤</p>
          <button class="btn btn-primary" onclick="testScenario3()">ì‹¤í–‰</button>
        </div>
        <div class="test-scenario">
          <h4>ì‹œë‚˜ë¦¬ì˜¤ 4: ëª…ë ¹-ì‘ë‹µ RPC</h4>
          <p>ë°±ì—”ë“œê°€ ëª…ë ¹ì„ ë³´ë‚´ê³  Monitorê°€ ì‘ë‹µí•˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤</p>
          <button class="btn btn-primary" onclick="testScenario4()">ì‹¤í–‰</button>
        </div>
        <div class="test-scenario">
          <h4>ì‹œë‚˜ë¦¬ì˜¤ 5: Telemetry ë°ì´í„°</h4>
          <p>í—ˆë¸Œê°€ Telemetry ë°ì´í„°ë¥¼ ì „ì†¡í•˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤</p>
          <button class="btn btn-primary" onclick="testScenario5()">ì‹¤í–‰</button>
        </div>
      </div>
    </div>

    <div class="controls">
      <h3>í•„í„°</h3>
      <div class="filters">
        <div class="form-group filter-input">
          <label>í† í”½ í•„í„°</label>
          <input type="text" id="topicFilter" placeholder="hub/..." oninput="applyFilters()" />
        </div>
        <div class="form-group" style="min-width: 150px;">
          <label>ë°©í–¥</label>
          <select id="directionFilter" onchange="applyFilters()">
            <option value="">ì „ì²´</option>
            <option value="incoming">ìˆ˜ì‹ </option>
            <option value="outgoing">ë°œì‹ </option>
            <option value="system">ì‹œìŠ¤í…œ</option>
          </select>
        </div>
      </div>
    </div>

    <div class="messages-container">
      <div class="messages-header">
        <h3>ë©”ì‹œì§€ ë¡œê·¸</h3>
        <span id="messageCount">0ê°œ</span>
      </div>
      <div class="messages-list" id="messagesList">
        <div class="empty-state">ë©”ì‹œì§€ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let allMessages = [];
    let filteredMessages = [];
    let currentFilters = { topic: '', direction: '' };

    // Socket.IO ì—°ê²°
    socket.on('connect', () => {
      console.log('Connected to monitor server');
      updateStatus(true);
    });

    socket.on('disconnect', () => {
      console.log('Disconnected from monitor server');
      updateStatus(false);
    });

    // ì‹¤ì‹œê°„ ë©”ì‹œì§€ ìˆ˜ì‹ 
    socket.on('mqtt_message', (message) => {
      allMessages.unshift(message);
      if (allMessages.length > 1000) {
        allMessages.pop();
      }
      applyFilters();
    });

    // í†µê³„ ì—…ë°ì´íŠ¸
    socket.on('stats_update', (stats) => {
      updateStats(stats);
    });

    // ìµœê·¼ ë©”ì‹œì§€ ë¡œë“œ
    socket.on('recent_messages', (messages) => {
      allMessages = messages;
      applyFilters();
    });

    // ë¡œê·¸ ì´ˆê¸°í™”
    socket.on('log_cleared', () => {
      allMessages = [];
      filteredMessages = [];
      renderMessages();
    });

    // ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateStatus(connected) {
      const indicator = document.getElementById('statusIndicator');
      const text = document.getElementById('statusText');
      
      if (connected) {
        indicator.classList.remove('disconnected');
        text.textContent = 'ì—°ê²°ë¨';
      } else {
        indicator.classList.add('disconnected');
        text.textContent = 'ì—°ê²° ì•ˆ ë¨';
      }
    }

    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateStats(stats) {
      document.getElementById('totalMessages').textContent = stats.totalMessages.toLocaleString();
      document.getElementById('incomingMessages').textContent = stats.messagesByDirection.incoming.toLocaleString();
      document.getElementById('outgoingMessages').textContent = stats.messagesByDirection.outgoing.toLocaleString();
      document.getElementById('connectedClients').textContent = stats.connectedClients;
      document.getElementById('uniqueTopics').textContent = stats.topics.length;

      // í† í”½ íƒœê·¸ ì—…ë°ì´íŠ¸
      const topicTags = document.getElementById('topicTags');
      topicTags.innerHTML = '';
      stats.topics.slice(0, 20).forEach(topic => {
        const tag = document.createElement('span');
        tag.className = 'topic-tag';
        tag.textContent = topic;
        tag.onclick = () => {
          document.getElementById('topicFilter').value = topic;
          applyFilters();
        };
        topicTags.appendChild(tag);
      });
    }

    // í•„í„° ì ìš©
    function applyFilters() {
      const topicFilter = document.getElementById('topicFilter').value.toLowerCase();
      const directionFilter = document.getElementById('directionFilter').value;

      currentFilters.topic = topicFilter;
      currentFilters.direction = directionFilter;

      filteredMessages = allMessages.filter(msg => {
        const matchesTopic = !topicFilter || msg.topic.toLowerCase().includes(topicFilter);
        const matchesDirection = !directionFilter || msg.direction === directionFilter;
        return matchesTopic && matchesDirection;
      });

      renderMessages();
    }

    // ë©”ì‹œì§€ ë Œë”ë§
    function renderMessages() {
      const list = document.getElementById('messagesList');
      const count = document.getElementById('messageCount');
      
      count.textContent = `${filteredMessages.length}ê°œ`;

      if (filteredMessages.length === 0) {
        list.innerHTML = '<div class="empty-state">ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      list.innerHTML = filteredMessages.map(msg => {
        // ë©”ì‹œì§€ í‘œì‹œ ìš°ì„ ìˆœìœ„: message (parsed) > payload (raw) > ë¹ˆ ë¬¸ìì—´
        let displayPayload = '';
        
        if (msg.message !== null && msg.message !== undefined) {
          if (typeof msg.message === 'object') {
            displayPayload = JSON.stringify(msg.message, null, 2);
          } else {
            displayPayload = String(msg.message);
          }
        } else if (msg.payload) {
          displayPayload = String(msg.payload);
        } else {
          displayPayload = '(empty message)';
        }

        // ë©”ì‹œì§€ í¬ê¸° ì •ë³´ ì¶”ê°€
        const sizeInfo = msg.size ? ` (${msg.size} bytes)` : '';

        return `
          <div class="message-item ${msg.direction}">
            <div class="message-header">
              <div>
                <span class="message-direction ${msg.direction}">${msg.direction.toUpperCase()}</span>
                <span class="message-topic">${msg.topic}${sizeInfo}</span>
              </div>
              <span class="message-time">${new Date(msg.timestamp).toLocaleString('ko-KR')}</span>
            </div>
            <div class="message-payload">${escapeHtml(displayPayload)}</div>
          </div>
        `;
      }).join('');
    }

    // HTML ì´ìŠ¤ì¼€ì´í”„
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ë°±ì—”ë“œ URL ê°€ì ¸ì˜¤ê¸° (ì•ˆì „í•˜ê²Œ)
    function getBackendUrl() {
      const urlInput = document.getElementById('backendUrl');
      const hiddenInput = document.getElementById('backendUrlHidden');
      
      if (urlInput && urlInput.value && urlInput.value.trim() !== '') {
        const url = urlInput.value.trim();
        // URL ìœ íš¨ì„± ê²€ì‚¬
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
          return 'http://localhost:5000'; // ê¸°ë³¸ê°’ ë°˜í™˜
        }
        // ìˆ¨ê²¨ì§„ í•„ë“œì—ë„ ì €ì¥
        if (hiddenInput) {
          hiddenInput.value = url;
        }
        return url;
      }
      
      // ìˆ¨ê²¨ì§„ í•„ë“œì—ì„œ ê°€ì ¸ì˜¤ê¸°
      if (hiddenInput && hiddenInput.value) {
        return hiddenInput.value;
      }
      
      // ê¸°ë³¸ê°’
      return 'http://localhost:5000';
    }

    // ë°œí–‰ ìœ„ì¹˜ì— ë”°ë¼ UI ì—…ë°ì´íŠ¸
    function updatePublishUI() {
      const source = document.getElementById('publishSource').value;
      const backendConfig = document.getElementById('backendConfig');
      if (source === 'backend') {
        backendConfig.style.display = 'block';
        // ë°±ì—”ë“œ URL í•„ë“œ ì´ˆê¸°í™” (ì˜ëª»ëœ ê°’ì´ ìˆì„ ìˆ˜ ìˆìŒ)
        const urlInput = document.getElementById('backendUrl');
        if (urlInput && (!urlInput.value || urlInput.value.includes('1883'))) {
          urlInput.value = 'http://localhost:5000';
        }
        testBackendConnection(); // ìë™ìœ¼ë¡œ ì—°ê²° í…ŒìŠ¤íŠ¸
      } else {
        backendConfig.style.display = 'none';
      }
    }

    // ë°±ì—”ë“œ ì—°ê²° í…ŒìŠ¤íŠ¸
    async function testBackendConnection() {
      const backendUrl = getBackendUrl();
      const statusDiv = document.getElementById('backendStatus');
      
      if (!statusDiv) return;
      
      statusDiv.textContent = 'ì—°ê²° í™•ì¸ ì¤‘...';
      statusDiv.style.color = '#FF9800';
      
      try {
        const response = await fetch(`${backendUrl}/mqtt-test/status`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success && result.connected) {
          statusDiv.textContent = 'âœ… ë°±ì—”ë“œ ì—°ê²°ë¨ (MQTT ì—°ê²°ë¨)';
          statusDiv.style.color = '#4CAF50';
        } else if (result.success && !result.connected) {
          statusDiv.textContent = 'âš ï¸ ë°±ì—”ë“œ ì—°ê²°ë¨ (MQTT ì—°ê²° ì•ˆ ë¨)';
          statusDiv.style.color = '#FF9800';
        } else {
          statusDiv.textContent = 'âŒ ë°±ì—”ë“œ ì‘ë‹µ ì˜¤ë¥˜';
          statusDiv.style.color = '#f44336';
        }
      } catch (error) {
        statusDiv.textContent = 'âŒ ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨: ' + error.message;
        statusDiv.style.color = '#f44336';
        console.error('Backend connection test error:', error);
      }
    }

    // ë©”ì‹œì§€ ë°œí–‰
    async function publishMessage() {
      const source = document.getElementById('publishSource').value;
      const topic = document.getElementById('publishTopic').value;
      const messageText = document.getElementById('publishMessage').value;
      const qos = parseInt(document.getElementById('publishQos').value);
      const retain = document.getElementById('publishRetain').value === 'true';

      if (!topic || !messageText) {
        alert('í† í”½ê³¼ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      let message;
      try {
        message = JSON.parse(messageText);
      } catch (e) {
        message = messageText;
      }

      try {
        let response;
        if (source === 'monitor') {
          // MQTT Monitorì—ì„œ ì§ì ‘ ë°œí–‰
          response = await fetch('/api/publish', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ topic, message, qos, retain })
          });
        } else {
          // ë°±ì—”ë“œ APIë¥¼ í†µí•´ ë°œí–‰
          const backendUrl = getBackendUrl();
          console.log('Publishing via backend:', backendUrl);
          response = await fetch(`${backendUrl}/mqtt-test/publish`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ topic, message, qos, retain })
          });
        }

        const result = await response.json();
        if (result.success) {
          console.log(`âœ… Message published from ${source}:`, result);
          if (source === 'monitor') {
            document.getElementById('publishTopic').value = '';
            document.getElementById('publishMessage').value = '';
          }
        } else {
          alert('ë°œí–‰ ì‹¤íŒ¨: ' + result.message);
        }
      } catch (error) {
        alert('ë°œí–‰ ì¤‘ ì˜¤ë¥˜: ' + error.message);
        console.error('Publish error:', error);
      }
    }

    // ì–‘ë°©í–¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    function runBidirectionalTest() {
      const testScenarios = document.getElementById('testScenarios');
      testScenarios.style.display = testScenarios.style.display === 'none' ? 'block' : 'none';
    }

    // ì‹œë‚˜ë¦¬ì˜¤ 1: Monitor â†’ Backend
    async function testScenario1() {
      console.log('ğŸ§ª Running Scenario 1: Monitor â†’ Backend');
      document.getElementById('publishSource').value = 'monitor';
      document.getElementById('publishTopic').value = 'test/monitor-to-backend';
      document.getElementById('publishMessage').value = JSON.stringify({
        source: 'mqtt-monitor',
        message: 'Test message from Monitor',
        timestamp: new Date().toISOString()
      }, null, 2);
      updatePublishUI();
      await publishMessage();
      alert('ì‹œë‚˜ë¦¬ì˜¤ 1 ì‹¤í–‰ ì™„ë£Œ!\në°±ì—”ë“œ í„°ë¯¸ë„ì—ì„œ ë©”ì‹œì§€ ìˆ˜ì‹ ì„ í™•ì¸í•˜ì„¸ìš”.');
    }

    // ì‹œë‚˜ë¦¬ì˜¤ 2: Backend â†’ Monitor
    async function testScenario2() {
      console.log('ğŸ§ª Running Scenario 2: Backend â†’ Monitor');
      document.getElementById('publishSource').value = 'backend';
      // ë°±ì—”ë“œ URL ì´ˆê¸°í™”
      const urlInput = document.getElementById('backendUrl');
      if (urlInput) {
        urlInput.value = 'http://localhost:5000';
      }
      const hiddenInput = document.getElementById('backendUrlHidden');
      if (hiddenInput) {
        hiddenInput.value = 'http://localhost:5000';
      }
      document.getElementById('publishTopic').value = 'test/backend-to-monitor';
      document.getElementById('publishMessage').value = JSON.stringify({
        source: 'backend',
        message: 'Test message from Backend',
        timestamp: new Date().toISOString()
      }, null, 2);
      updatePublishUI();
      await publishMessage();
      alert('ì‹œë‚˜ë¦¬ì˜¤ 2 ì‹¤í–‰ ì™„ë£Œ!\nMQTT Monitorì—ì„œ ë©”ì‹œì§€ ìˆ˜ì‹ ì„ í™•ì¸í•˜ì„¸ìš”.');
    }

    // ì‹œë‚˜ë¦¬ì˜¤ 3: í—ˆë¸Œ ìƒíƒœ ì‹œë®¬ë ˆì´ì…˜
    async function testScenario3() {
      console.log('ğŸ§ª Running Scenario 3: Hub Status');
      document.getElementById('publishSource').value = 'monitor';
      document.getElementById('publishTopic').value = 'hub/AA:BB:CC:DD:EE:01/status';
      document.getElementById('publishMessage').value = JSON.stringify({
        status: 'online',
        timestamp: new Date().toISOString(),
        version: '1.0.0',
        connectedDevices: 3
      }, null, 2);
      updatePublishUI();
      await publishMessage();
      alert('ì‹œë‚˜ë¦¬ì˜¤ 3 ì‹¤í–‰ ì™„ë£Œ!\në°±ì—”ë“œì—ì„œ í—ˆë¸Œ ìƒíƒœë¡œ ì²˜ë¦¬ë˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
    }

    // ì‹œë‚˜ë¦¬ì˜¤ 4: ëª…ë ¹-ì‘ë‹µ RPC
    async function testScenario4() {
      console.log('ğŸ§ª Running Scenario 4: Command-Response RPC');
      
      // ë°±ì—”ë“œ URL ê°•ì œ ì´ˆê¸°í™” ë° í™•ì¸
      const urlInput = document.getElementById('backendUrl');
      const hiddenInput = document.getElementById('backendUrlHidden');
      const correctUrl = 'http://localhost:5000';
      
      // ì˜ëª»ëœ í¬íŠ¸(1883 ë“±)ê°€ ìˆìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ ì¬ì„¤ì •
      if (urlInput) {
        const currentValue = urlInput.value || '';
        if (!currentValue || currentValue.includes('1883') || !currentValue.includes('5000') || !currentValue.startsWith('http')) {
          console.log('Resetting backend URL from', currentValue, 'to', correctUrl);
          urlInput.value = correctUrl;
        }
      }
      
      if (hiddenInput) {
        hiddenInput.value = correctUrl;
      }
      
      const backendUrl = getBackendUrl();
      console.log('Using backend URL:', backendUrl);
      
      // URL ìœ íš¨ì„± ìµœì¢… í™•ì¸
      if (!backendUrl || backendUrl.includes('1883') || !backendUrl.includes('5000')) {
        alert('âŒ ë°±ì—”ë“œ URLì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì˜¬ë°”ë¥¸ URL: http://localhost:5000\ní˜„ì¬ URL: ' + backendUrl + '\n\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
        return;
      }
      
      // ë¨¼ì € ë°±ì—”ë“œ ì—°ê²° í™•ì¸
      try {
        const statusResponse = await fetch(`${backendUrl}/mqtt-test/status`);
        if (!statusResponse.ok) {
          throw new Error(`ë°±ì—”ë“œ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (${statusResponse.status})`);
        }
        const statusResult = await statusResponse.json();
        if (!statusResult.connected) {
          alert('âš ï¸ ë°±ì—”ë“œì˜ MQTT ì„œë¹„ìŠ¤ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\në°±ì—”ë“œ ì„œë²„ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
          return;
        }
      } catch (error) {
        alert('âŒ ë°±ì—”ë“œ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní™•ì¸ ì‚¬í•­:\n1. ë°±ì—”ë“œ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸\n2. ë°±ì—”ë“œ URLì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸ (í˜„ì¬: ' + backendUrl + ')\n3. CORS ì„¤ì • í™•ì¸\n\nì˜¤ë¥˜: ' + error.message);
        console.error('Backend connection error:', error);
        return;
      }
      
      const commandTopic = 'hub/AA:BB:CC:DD:EE:01/command/AA:BB:CC:DD:EE:02';
      const requestId = `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      const command = {
        action: 'led_blink',
        duration: 1000,
        requestId: requestId,
        timestamp: new Date().toISOString()
      };
      
      try {
        // ë°±ì—”ë“œê°€ ëª…ë ¹ ë°œí–‰
        console.log('Sending command to backend:', { topic: commandTopic, message: command });
        const commandResponse = await fetch(`${backendUrl}/mqtt-test/publish`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            topic: commandTopic,
            message: command,
            qos: 1,
            retain: false
          })
        });
        
        if (!commandResponse.ok) {
          const errorText = await commandResponse.text();
          throw new Error(`HTTP ${commandResponse.status}: ${errorText}`);
        }
        
        const commandResult = await commandResponse.json();
        console.log('Command sent:', commandResult);
        
        if (!commandResult.success) {
          throw new Error(commandResult.message || 'ëª…ë ¹ ë°œí–‰ ì‹¤íŒ¨');
        }
        
        // ìë™ìœ¼ë¡œ ì‘ë‹µ ë°œí–‰
        setTimeout(async () => {
          const responseTopic = 'hub/AA:BB:CC:DD:EE:01/response/AA:BB:CC:DD:EE:02';
          const responseMessage = {
            requestId: requestId,
            success: true,
            result: 'LED blinked successfully',
            timestamp: new Date().toISOString()
          };
          
          console.log('Publishing response:', { topic: responseTopic, message: responseMessage });
          
          document.getElementById('publishSource').value = 'monitor';
          document.getElementById('publishTopic').value = responseTopic;
          document.getElementById('publishMessage').value = JSON.stringify(responseMessage, null, 2);
          updatePublishUI();
          
          try {
            await publishMessage();
            alert('âœ… ì‹œë‚˜ë¦¬ì˜¤ 4 ì‹¤í–‰ ì™„ë£Œ!\n\n1. ë°±ì—”ë“œì—ì„œ ëª…ë ¹ ë°œí–‰ë¨\n2. Monitorì—ì„œ ì‘ë‹µ ë°œí–‰ë¨\n\në°±ì—”ë“œ í„°ë¯¸ë„ì—ì„œ ì‘ë‹µ ìˆ˜ì‹ ì„ í™•ì¸í•˜ì„¸ìš”.');
          } catch (publishError) {
            console.error('Response publish error:', publishError);
            alert('ëª…ë ¹ì€ ë°œí–‰ë˜ì—ˆì§€ë§Œ ì‘ë‹µ ë°œí–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n' + publishError.message);
          }
        }, 1000);
        
      } catch (error) {
        const errorMsg = error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
        alert('âŒ ì‹œë‚˜ë¦¬ì˜¤ 4 ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜:\n\n' + errorMsg + '\n\në¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        console.error('Scenario 4 error:', error);
      }
    }

    // ì‹œë‚˜ë¦¬ì˜¤ 5: Telemetry ë°ì´í„°
    async function testScenario5() {
      console.log('ğŸ§ª Running Scenario 5: Telemetry Data');
      document.getElementById('publishSource').value = 'monitor';
      document.getElementById('publishTopic').value = 'hub/AA:BB:CC:DD:EE:01/telemetry/AA:BB:CC:DD:EE:02';
      
      // ìƒ˜í”Œ Telemetry ë°ì´í„° ìƒì„±
      const dataArr = [];
      for (let i = 0; i < 10; i++) {
        dataArr.push({
          ir: 30000 + Math.floor(Math.random() * 5000),
          red: 15000 + Math.floor(Math.random() * 3000),
          green: 9000 + Math.floor(Math.random() * 2000),
          spo2: 95 + Math.floor(Math.random() * 5),
          hr: 70 + Math.floor(Math.random() * 20),
          temp: 37.0 + Math.random() * 2,
          battery: 80 + Math.floor(Math.random() * 20)
        });
      }
      
      const telemetryData = {
        device_mac_address: 'AA:BB:CC:DD:EE:02',
        timestamp: Date.now(),
        starttime: Date.now() - 10000,
        dataArr: dataArr
      };
      
      document.getElementById('publishMessage').value = JSON.stringify(telemetryData, null, 2);
      updatePublishUI();
      await publishMessage();
      alert('ì‹œë‚˜ë¦¬ì˜¤ 5 ì‹¤í–‰ ì™„ë£Œ!\në°±ì—”ë“œì—ì„œ Telemetry ë°ì´í„°ë¡œ ì²˜ë¦¬ë˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
    }

    // ë¡œê·¸ ì´ˆê¸°í™”
    async function clearLog() {
      if (!confirm('ë¡œê·¸ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        const response = await fetch('/api/clear', { method: 'POST' });
        const result = await response.json();
        if (result.success) {
          allMessages = [];
          filteredMessages = [];
          renderMessages();
        }
      } catch (error) {
        alert('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜: ' + error.message);
      }
    }

    // ìµœê·¼ ë©”ì‹œì§€ ìƒˆë¡œê³ ì¹¨
    async function loadRecentMessages() {
      try {
        const response = await fetch('/api/messages?limit=100');
        const result = await response.json();
        if (result.success) {
          allMessages = result.data;
          applyFilters();
        }
      } catch (error) {
        console.error('Failed to load messages:', error);
      }
    }

    // ì´ˆê¸° ë¡œë“œ
    loadRecentMessages();
    setInterval(loadRecentMessages, 5000); // 5ì´ˆë§ˆë‹¤ ìƒˆë¡œê³ ì¹¨
  </script>
</body>
</html>

